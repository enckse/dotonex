#!/bin/bash

_randomstring() {
    cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w ${1:-32} | head -n 1
}

_init() {
    local pass cwd
    echo "performing first-time grad setup"
    pass=$(_randomstring)
    mkdir -p HOSTAPD
    chmod 600 HOSTAPD
    cp TEMPLATE* HOSTAPD/
    sed -i "s/{PASSWORD}/$pass/g" HOSTAPD/*.cnf
    pass=$(_randomstring)
    echo "127.0.0.1 $pass" > CLIENTS
    cd HOSTAPD && ./bootstrap
    echo "$pass" > GRADKEY
    cwd=$PWD
}

if [ ! -d HOSTAPD ]; then
    _init
fi

while [ 1 -eq 1]; do
    if ! pgrep hostapd > /dev/null; then
        echo "starting hostapd"
        hostapd HOSTAPD/hostapd.conf
    fi
    if ! pgrep grad > /dev/null; then
        echo "starting grad"
        grad serve ETCGRAD/grad.conf
    fi
    sleep 30;
done
