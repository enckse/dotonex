#!/bin/bash

_randomstring() {
    cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w ${1:-32} | head -n 1
}

_init() {
    local pass cwd
    echo "performing first-time grad setup"
    pass=$(_randomstring)
    mkdir -p LIBRARY HOSTAPD
    chmod 600 LIBRARY
    cp TEMPLATE* HOSTAPD/
    sed -i "s/{PASSWORD}/$pass/g" HOSTAPD/*.cnf
    pass=$(_randomstring)
    echo "127.0.0.1 $pass" > CLIENTS
    cd HOSTAPD && ./bootstrap
    echo "$pass" > GRADKEY
    cwd=$PWD
}

if [ ! -d LIBRARY ]; then
    _init
fi

if [ ! -d LOGS ]; then
    mkdir -p LOGS
    chown 600 LOGS
fi

yesterday=""
while [ 1 -eq 1]; do
    today=$(date +%Y-%m-%d)
    if [[ "$today" != "$yesterday" ]]; then
        echo" clearing services"
        pkill hostapd
        pkill grad
    fi
    yesterday=$today
    if ! pgrep hostapd > /dev/null; then
        echo "starting hostapd"
        hostapd HOSTAPD/hostapd.conf &
    fi
    if ! pgrep grad > /dev/null; then
        echo "starting grad"
        grad serve -config ETCGRAD/grad.conf &
    fi
    sleep 30;
done
